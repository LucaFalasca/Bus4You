{% extends 'base.html' %}

    {% block stylesheets%}
         <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
        <link rel="stylesheet" type="text/css" href="../static/css/userRoutes.css">
    {% endblock %}

    {% block body %}
    <script>
        var busStopIcon = L.Icon.extend({
            options: {
                iconSize:     [60, 60],
                iconAnchor:   [30, 60]
            }
        });
        var busStopIconBlue = new busStopIcon({iconUrl: '/static/resources/bus-stop-blue.png' });
        var busStopIconGreen = new busStopIcon({iconUrl: '/static/resources/bus-stop-green.png' });
        var busStopIconRed = new busStopIcon({iconUrl: '/static/resources/bus-stop-red.png' });
    </script>
        <div class="accordion" id="accAttive">
          <div id="accItmAttive" class="accordion-item">
            <h1 class="accordion-header " id="headingAttive">
              <button id="btnAttive" class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAttive" aria-expanded="true" aria-controls="collapseAttive">
                PRENOTAZIONI ATTIVE
              </button>
            </h1>
            <div id="collapseAttive" class="accordion-collapse collapse show" data-bs-parent="#accAttive" role="region" aria-labelledby="headingAttive">
              <div class="accordion-body">
                <div id="divAccordionPresent" class="accordion accordion-background-hover accordion-background-active">
                    {% for route in present_routes %}
                        {% if route.getRouteStatus()=='confirmed' and route.getItStatus()=='confirmed' %}
                        <div id="divAccConf{{ present_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ present_routes.index(route) }}">
                          <button id="btnAccConf{{ present_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ present_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ present_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ present_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccConf" role="region" aria-labelledby="head{{ present_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>
                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>
                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>
                                        Fermata Partenza: {{ route.getStartStop() }} <br>
                                        Fermata Arrivo: {{ route.getEndStop() }} <br>
                                        Costo: {{ route.getItCost() }}<br>
                                        Stato Itinerario: {{ route.getItStatus() }}<br>
                                        Stato Percorso: {{ route.getRouteStatus() }}<br>
                                        
                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map{{ present_routes.index(route) }}"></div>
                                        <script>
                                            var map{{ present_routes.index(route) }} = L.map('map{{ present_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map{{ present_routes.index(route) }});


                                            var myCollapsible{{ present_routes.index(route) }} = document.getElementById('acc{{ present_routes.index(route) }}');
                                            myCollapsible{{ present_routes.index(route) }}.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ present_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map{{ present_routes.index(route) }});

                                                        map{{ present_routes.index(route) }}.invalidateSize();

                                                        map{{ present_routes.index(route) }}.fitBounds(path{{ present_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map{{ present_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });

                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif route.getRouteStatus()=='confirmed' and route.getItStatus()=='pending'%}
                        <div id="divAccPend{{ present_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ present_routes.index(route) }}">
                          <button id="btnAccPend{{ present_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ present_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ present_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ present_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccPend" role="region" aria-labelledby="head{{ present_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>

                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>

                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>

                                        Fermata Partenza: {{ route.getStartStop() }} <br>

                                        Fermata Arrivo: {{ route.getEndStop() }} <br>

                                        Costo: {{ route.getItCost() }}<br>

                                        Stato Itinerario: {{ route.getItStatus() }}<br>

                                        Stato Percorso: {{ route.getRouteStatus() }}<br>

                                        

                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>

                                        <button id="btnConfirm{{ present_routes.index(route) }}" data-bs-toggle="modal" data-bs-target="#confirmModal{{ present_routes.index(route) }}">Confirm Book</button>
                                        <button id="btnReject{{ present_routes.index(route) }}" data-bs-toggle="modal" data-bs-target="#rejectModal{{ present_routes.index(route) }}">Reject Book</button>

                                        <!-- Modal Reject -->
                                        <div class="modal fade" tabindex="-1" role="dialog" id="rejectModal{{ present_routes.index(route) }}" aria-labelledby="rejectModalTitle" aria-describedby="rejectModalDescription">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <h5>Are you sure you want to reject the proposed book?</h5>
                                                    </div>
                                                    <form action="/reject_book" method="post">
                                                        <div class="modal-body">
                                                            <input type="checkbox" id="chkBox{{ present_routes.index(route) }}" name="chkBox{{ present_routes.index(route) }}" value="True">
                                                            <label id="lbChkBox{{ present_routes.index(route) }}" for="chkBox{{ present_routes.index(route) }}"> Search another route</label><br>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button id="btnModalRejectClose{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                                                            <input class="form-control" type="hidden" id="itId{{ present_routes.index(route) }}" name="itId{{ present_routes.index(route) }}" value="{{ route.getItId() }}">
                                                            <input class="form-control" type="hidden" id="startHour{{ present_routes.index(route) }}" name="startHour{{ present_routes.index(route) }}" value="{{ route.getItPropStart() }}">
                                                            <input class="form-control" type="hidden" id="endHour{{ present_routes.index(route) }}" name="endHour{{ present_routes.index(route) }}" value="{{ route.getItPropEnd() }}">
                                                            <input class="form-control" type="hidden" id="startStop{{ present_routes.index(route) }}" name="startStop{{ present_routes.index(route) }}" value="{{ route.getStartStop() }}">
                                                            <input class="form-control" type="hidden" id="endStop{{ present_routes.index(route) }}" name="endStop{{ present_routes.index(route) }}" value="{{ route.getEndStop() }}">
                                                            <input class="form-control" type="hidden" id="cost{{ present_routes.index(route) }}" name="cost{{ present_routes.index(route) }}" value="{{ route.getItCost() }}">
                                                            <input class="form-control" type="hidden" id="itStatus{{ present_routes.index(route) }}" name="itStatus{{ present_routes.index(route) }}" value="{{ route.getItStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeStatus{{ present_routes.index(route) }}" name="routeStatus{{ present_routes.index(route) }}" value="{{ route.getRouteStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeIsPast{{ present_routes.index(route) }}" name="routeIsPast{{ present_routes.index(route) }}" value="{{ route.isPast() }}">
                                                            <input class="form-control" type="hidden" id="routeExpire{{ present_routes.index(route) }}" name="routeExpire{{ present_routes.index(route) }}" value="{{ route.getRouteExpire() }}">

                                                            <input type=submit id="btnModalReject{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" value="Reject">
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Modal Confirm -->
                                        <div class="modal fade" tabindex="-1" role="dialog" id="confirmModal{{ present_routes.index(route) }}" aria-labelledby="confirmModalTitle" aria-describedby="confirmModalDescription">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <h5>Are you sure you want to confirm the proposed book?</h5>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button id="btnModalConfirmClose{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                                                        <form action="/confirm_book" method="post">
                                                            <input class="form-control" type="hidden" id="itId{{ present_routes.index(route) }}" name="itId{{ present_routes.index(route) }}" value="{{ route.getItId() }}">
                                                            <input class="form-control" type="hidden" id="startHour{{ present_routes.index(route) }}" name="startHour{{ present_routes.index(route) }}" value="{{ route.getItPropStart() }}">
                                                            <input class="form-control" type="hidden" id="endHour{{ present_routes.index(route) }}" name="endHour{{ present_routes.index(route) }}" value="{{ route.getItPropEnd() }}">
                                                            <input class="form-control" type="hidden" id="startStop{{ present_routes.index(route) }}" name="startStop{{ present_routes.index(route) }}" value="{{ route.getStartStop() }}">
                                                            <input class="form-control" type="hidden" id="endStop{{ present_routes.index(route) }}" name="endStop{{ present_routes.index(route) }}" value="{{ route.getEndStop() }}">
                                                            <input class="form-control" type="hidden" id="cost{{ present_routes.index(route) }}" name="cost{{ present_routes.index(route) }}" value="{{ route.getItCost() }}">
                                                            <input class="form-control" type="hidden" id="itStatus{{ present_routes.index(route) }}" name="itStatus{{ present_routes.index(route) }}" value="{{ route.getItStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeStatus{{ present_routes.index(route) }}" name="routeStatus{{ present_routes.index(route) }}" value="{{ route.getRouteStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeIsPast{{ present_routes.index(route) }}" name="routeIsPast{{ present_routes.index(route) }}" value="{{ route.isPast() }}">
                                                            <input class="form-control" type="hidden" id="routeExpire{{ present_routes.index(route) }}" name="routeExpire{{ present_routes.index(route) }}" value="{{ route.getRouteExpire() }}">

                                                            <input type=submit id="btnModalConfirm{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" value="Confirm and Pay">
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map{{ present_routes.index(route) }}"></div>
                                        <script>
                                            var map{{ present_routes.index(route) }} = L.map('map{{ present_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map{{ present_routes.index(route) }});


                                            var myCollapsible{{ present_routes.index(route) }} = document.getElementById('acc{{ present_routes.index(route) }}');
                                            myCollapsible{{ present_routes.index(route) }}.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ present_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map{{ present_routes.index(route) }});

                                                        map{{ present_routes.index(route) }}.invalidateSize();

                                                        map{{ present_routes.index(route) }}.fitBounds(path{{ present_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map{{ present_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });

                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                            {% elif route.getRouteStatus()=='pending' and (route.getItStatus()=='pending' or route.getItStatus()=='confirmed')%}
                        <div id="divAccPend{{ present_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ present_routes.index(route) }}">
                          <button id="btnAccPend{{ present_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ present_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ present_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ present_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccPend" role="region" aria-labelledby="head{{ present_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                       Data: {{ route.getItPropStart()[0:10]}} <br>

                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>

                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>

                                        Fermata Partenza: {{ route.getStartStop() }} <br>

                                        Fermata Arrivo: {{ route.getEndStop() }} <br>

                                        Costo: {{ route.getItCost() }}<br>

                                        Stato Itinerario: {{ route.getItStatus() }}<br>

                                        Stato Percorso: {{ route.getRouteStatus() }}<br>

                                        

                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>

                                        {% if route.getItStatus()=='confirmed' %}
                                            <button id="btnConfirmDis{{ present_routes.index(route) }}" data-bs-toggle="modal" data-bs-target="#confirmModal{{ present_routes.index(route) }} disabled">Confirm Book</button>
                                        {% else %}
                                            <button id="btnConfirm{{ present_routes.index(route) }}" data-bs-toggle="modal" data-bs-target="#confirmModal{{ present_routes.index(route) }}">Confirm Book</button>
                                        {% endif %}
                                        <button id="btnReject{{ present_routes.index(route) }}" data-bs-toggle="modal" data-bs-target="#rejectModal{{ present_routes.index(route) }}">Reject Book</button>

                                        <!-- Modal Reject -->
                                        <div class="modal fade" tabindex="-1" role="dialog" id="rejectModal{{ present_routes.index(route) }}" aria-labelledby="rejectModalTitle" aria-describedby="rejectModalDescription">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <h5>Are you sure you want to reject the proposed book?</h5>
                                                    </div>
                                                    <form action="/reject_book" method="post">
                                                        <div class="modal-body">
                                                           <input type="checkbox" id="chkBox{{ present_routes.index(route) }}" name="chkBox{{ present_routes.index(route) }}" value="True">
                                                            <label id="lbChkBox{{ present_routes.index(route) }}" for="chkBox{{ present_routes.index(route) }}"> Search another route</label><br>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button id="btnModalRejectClose{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                                                            <input class="form-control" type="hidden" id="itId{{ present_routes.index(route) }}" name="itId{{ present_routes.index(route) }}" value="{{ route.getItId() }}">
                                                            <input class="form-control" type="hidden" id="startHour{{ present_routes.index(route) }}" name="startHour{{ present_routes.index(route) }}" value="{{ route.getItPropStart() }}">
                                                            <input class="form-control" type="hidden" id="endHour{{ present_routes.index(route) }}" name="endHour{{ present_routes.index(route) }}" value="{{ route.getItPropEnd() }}">
                                                            <input class="form-control" type="hidden" id="startStop{{ present_routes.index(route) }}" name="startStop{{ present_routes.index(route) }}" value="{{ route.getStartStop() }}">
                                                            <input class="form-control" type="hidden" id="endStop{{ present_routes.index(route) }}" name="endStop{{ present_routes.index(route) }}" value="{{ route.getEndStop() }}">
                                                            <input class="form-control" type="hidden" id="cost{{ present_routes.index(route) }}" name="cost{{ present_routes.index(route) }}" value="{{ route.getItCost() }}">
                                                            <input class="form-control" type="hidden" id="itStatus{{ present_routes.index(route) }}" name="itStatus{{ present_routes.index(route) }}" value="{{ route.getItStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeStatus{{ present_routes.index(route) }}" name="routeStatus{{ present_routes.index(route) }}" value="{{ route.getRouteStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeIsPast{{ present_routes.index(route) }}" name="routeIsPast{{ present_routes.index(route) }}" value="{{ route.isPast() }}">
                                                            <input class="form-control" type="hidden" id="routeExpire{{ present_routes.index(route) }}" name="routeExpire{{ present_routes.index(route) }}" value="{{ route.getRouteExpire() }}">

                                                            <input type=submit id="btnModalReject{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" value="Reject">
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Modal Confirm -->
                                        <div class="modal fade" tabindex="-1" role="dialog" id="confirmModal{{ present_routes.index(route) }}" aria-labelledby="confirmModalTitle" aria-describedby="confirmModalDescription">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <h5>Are you sure you want to confirm the proposed book?</h5>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button id="btnModalConfirmClose{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                                                        <form action="/confirm_book" method="post">
                                                            <input class="form-control" type="hidden" id="itId{{ present_routes.index(route) }}" name="itId{{ present_routes.index(route) }}" value="{{ route.getItId() }}">
                                                            <input class="form-control" type="hidden" id="startHour{{ present_routes.index(route) }}" name="startHour{{ present_routes.index(route) }}" value="{{ route.getItPropStart() }}">
                                                            <input class="form-control" type="hidden" id="endHour{{ present_routes.index(route) }}" name="endHour{{ present_routes.index(route) }}" value="{{ route.getItPropEnd() }}">
                                                            <input class="form-control" type="hidden" id="startStop{{ present_routes.index(route) }}" name="startStop{{ present_routes.index(route) }}" value="{{ route.getStartStop() }}">
                                                            <input class="form-control" type="hidden" id="endStop{{ present_routes.index(route) }}" name="endStop{{ present_routes.index(route) }}" value="{{ route.getEndStop() }}">
                                                            <input class="form-control" type="hidden" id="cost{{ present_routes.index(route) }}" name="cost{{ present_routes.index(route) }}" value="{{ route.getItCost() }}">
                                                            <input class="form-control" type="hidden" id="itStatus{{ present_routes.index(route) }}" name="itStatus{{ present_routes.index(route) }}" value="{{ route.getItStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeStatus{{ present_routes.index(route) }}" name="routeStatus{{ present_routes.index(route) }}" value="{{ route.getRouteStatus() }}">
                                                            <input class="form-control" type="hidden" id="routeIsPast{{ present_routes.index(route) }}" name="routeIsPast{{ present_routes.index(route) }}" value="{{ route.isPast() }}">
                                                            <input class="form-control" type="hidden" id="routeExpire{{ present_routes.index(route) }}" name="routeExpire{{ present_routes.index(route) }}" value="{{ route.getRouteExpire() }}">

                                                            <input type=submit id="btnModalConfirm{{ present_routes.index(route) }}" class="btn btn-primary btn-sm" value="Confirm and Pay">
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map{{ present_routes.index(route) }}"></div>
                                        <script>
                                            var map{{ present_routes.index(route) }} = L.map('map{{ present_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map{{ present_routes.index(route) }});


                                            var myCollapsible{{ present_routes.index(route) }} = document.getElementById('acc{{ present_routes.index(route) }}');
                                            myCollapsible{{ present_routes.index(route) }}.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ present_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map{{ present_routes.index(route) }});

                                                        map{{ present_routes.index(route) }}.invalidateSize();

                                                        map{{ present_routes.index(route) }}.fitBounds(path{{ present_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map{{ present_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });

                                            

                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <div id="divAccRej{{ present_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ present_routes.index(route) }}">
                          <button id="btnAccRej{{ present_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ present_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ present_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ present_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccRej" role="region" aria-labelledby="head{{ present_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>
                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>
                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>
                                        Fermata Partenza: {{ route.getStartStop() }} <br>
                                        Fermata Arrivo: {{ route.getEndStop() }} <br>
                                        Costo: {{ route.getItCost() }}<br>
                                        Stato Itinerario: {{ route.getItStatus() }}<br>
                                        Stato Percorso: {{ route.getRouteStatus() }}<br>
                                        
                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map{{ present_routes.index(route) }}"></div>
                                        <script>
                                            var map{{ present_routes.index(route) }} = L.map('map{{ present_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map{{ present_routes.index(route) }});


                                            var myCollapsible{{ present_routes.index(route) }} = document.getElementById('acc{{ present_routes.index(route) }}');
                                            myCollapsible{{ present_routes.index(route) }}.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ present_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map{{ present_routes.index(route) }});

                                                        map{{ present_routes.index(route) }}.invalidateSize();

                                                        map{{ present_routes.index(route) }}.fitBounds(path{{ present_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map{{ present_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map{{ present_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });




                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion" id="accPast">
          <div id="accItmPast" class="accordion-item">
            <h1 class="accordion-header " id="headingPast">
              <button id="btnPast" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePast" aria-expanded="true" aria-controls="collapsePast">
                PRENOTAZIONI PASSATE
              </button>
            </h1>
            <div id="collapsePast" class="accordion-collapse collapse" data-bs-parent="#accPast" role="region" aria-labelledby="headingPast">
              <div class="accordion-body">
                <div id="divAccordionPast" class="accordion accordion-background-hover accordion-background-active">
                {% for route in past_routes %}
                    {% if route.getRouteStatus()=='confirmed' and route.getItStatus()=='confirmed' %}
                        <div id="divAccConf{{ past_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ past_routes.index(route) }}">
                          <button id="btnAccConf{{ past_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ past_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ past_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ past_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccConf" role="region" aria-labelledby="head{{ past_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>
                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>
                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>
                                        Fermata Partenza: {{ route.getStartStop() }} <br>
                                        Fermata Arrivo: {{ route.getEndStop() }} <br>
                                        Costo: {{ route.getItCost() }}<br>
                                        Stato Itinerario: {{ route.getItStatus() }}<br>
                                        Stato Percorso: {{ route.getRouteStatus() }}<br>
                                        
                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map_past{{ past_routes.index(route) }}"></div>
                                        <script>
                                            var map_past{{ past_routes.index(route) }} = L.map('map_past{{ past_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map_past{{ past_routes.index(route) }});

                                            var myCollapsible_past = document.getElementById('acc{{ past_routes.index(route) }}');
                                            myCollapsible_past.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ past_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map_past{{ past_routes.index(route) }});

                                                        map_past{{ past_routes.index(route) }}.invalidateSize();

                                                        map_past{{ past_routes.index(route) }}.fitBounds(path{{ past_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map_past{{ past_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });

                                        </script>
                                    </div>
                                  </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    {% elif route.getRouteStatus()=='confirmed' and route.getItStatus()=='pending'%}
                        <div id="divAccPend{{ past_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ past_routes.index(route) }}">
                          <button id="btnAccPend{{ past_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ past_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ past_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ past_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccPend" role="region" aria-labelledby="head{{ past_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>
                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>
                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>
                                        Fermata Partenza: {{ route.getStartStop() }} <br>
                                        Fermata Arrivo: {{ route.getEndStop() }} <br>
                                        Costo: {{ route.getItCost() }}<br>
                                        Stato Itinerario: {{ route.getItStatus() }}<br>
                                        Stato Percorso: {{ route.getRouteStatus() }}<br>
                                        
                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map_past{{ past_routes.index(route) }}"></div>
                                        <script>
                                            var map_past{{ past_routes.index(route) }} = L.map('map_past{{ past_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map_past{{ past_routes.index(route) }});

                                            console.log("sto qua")


                                            var myCollapsible_past = document.getElementById('acc{{ past_routes.index(route) }}');
                                            myCollapsible_past.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ past_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map_past{{ past_routes.index(route) }});

                                                        map_past{{ past_routes.index(route) }}.invalidateSize();

                                                        map_past{{ past_routes.index(route) }}.fitBounds(path{{ past_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map_past{{ past_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });


                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <div id="divAccRej{{ past_routes.index(route) }}" class="accordion-item">
                        <h2 class="accordion-header" id="head{{ past_routes.index(route) }}">
                          <button id="btnAccRej{{ past_routes.index(route) }}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ past_routes.index(route) }}" aria-expanded="false" aria-controls="acc{{ past_routes.index(route) }}">
                           {{ route.getStartStop() }} -> {{ route.getEndStop() }} - Data: {{ route.getItPropStart()[0:10] }} - Partenza: {{ route.getItPropStart()[11:] }} - Arrivo: {{ route.getItPropEnd()[11:]}}
                          </button>
                        </h2>
                        <div id="acc{{ past_routes.index(route) }}" class="accordion-collapse collapse" data-bs-parent="#divAccRej" role="region" aria-labelledby="head{{ past_routes.index(route) }}">
                            <div class="accordion-body">
                                <div class="container">
                                  <div class="row">
                                    <div class="col-sm-6">
                                        Data: {{ route.getItPropStart()[0:10]}} <br>
                                        Orario Partenza: {{ route.getItPropStart()[11:] }} <br>
                                        Orario Arrivo: {{ route.getItPropEnd()[11:]}} <br>
                                        Fermata Partenza: {{ route.getStartStop() }} <br>
                                        Fermata Arrivo: {{ route.getEndStop() }} <br>
                                        Costo: {{ route.getItCost() }}<br>
                                        Stato Itinerario: {{ route.getItStatus() }}<br>
                                        Stato Percorso: {{ route.getRouteStatus() }}<br>
                                        
                                        Scadenza Percorso: {{ route.getRouteExpire() }}<br>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="map" id="map_past{{ past_routes.index(route) }}"></div>
                                        <script>

                                            var map_past{{ past_routes.index(route) }} = L.map('map_past{{ past_routes.index(route) }}');


                                            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                            }).addTo(map_past{{ past_routes.index(route) }});


                                            var myCollapsible_past = document.getElementById('acc{{ past_routes.index(route) }}');
                                            myCollapsible_past.addEventListener('shown.bs.collapse', function () {


                                                var data_in = {{ route.getItId() }};
                                                console.log("DATA_IN:" + data_in);

                                                fetch('/_get_path', {
                                                      method: 'POST',
                                                      body: JSON.stringify(data_in),
                                                      headers: {
                                                        'Content-Type': 'application/json'
                                                      }
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.result)
                                                        console.log(data.result["coordinates"])
                                                        var path{{ past_routes.index(route) }} = L.polyline(data.result["coordinates"], {color: 'red'}).addTo(map_past{{ past_routes.index(route) }});

                                                        map_past{{ past_routes.index(route) }}.invalidateSize();

                                                        map_past{{ past_routes.index(route) }}.fitBounds(path{{ past_routes.index(route) }}.getBounds());

                                                        bus_stops = data.result["stops"]

                                                        console.log(bus_stops)

                                                        var markersLayer = L.featureGroup().addTo(map_past{{ past_routes.index(route) }});

                                                        var c = 0;
                                                        bus_stops.forEach(function(bus_stop) {
                                                            c++;
                                                            console.log("ao" + bus_stop)
                                                            if(bus_stop == bus_stops[0]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconGreen,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            else if(bus_stop == bus_stops[bus_stops.length - 1]){
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconRed,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata " + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            } else{
                                                                var marker = L.marker([bus_stop[1], bus_stop[0]], {
                                                                    icon: busStopIconBlue,
                                                                    title: "(" + bus_stop[1] + "," + bus_stop[0] + ")"
                                                                }).addTo(map_past{{ past_routes.index(route) }});
                                                                marker.bindTooltip("Fermata" + c, {
                                                                    offset: L.point(0, -50)
                                                                });
                                                            }
                                                            marker.addTo(markersLayer);
                                                        });  
                                                    });

                                            });

                                        </script>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
    {% endblock %}


