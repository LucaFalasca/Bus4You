
<style>
    #map { height: 100% }
</style>
{% extends 'base.html' %}

{% block stylesheets%}
    <title>GatewayAPI - Select route from map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
    crossorigin=""></script>
    <input type="hidden" id="response" value= "{{ ok }}">
    <link rel="stylesheet" type="text/css" href="../static/css/select_route_from_map.css">
{% endblock %}

{% block body %}
    <div class="container-fluid h-80">
      <div class="row g-0 h-80">
        <div class="col-sm-4">
            <form action="/select-route-from-map" method="GET">
                <input type="hidden" id="username" name="user" value={{ session['usr'] }}><br>
                <div class="row">
                  <div class="col-12">
                      <label>Start Point</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col-9">
                      <!-- campo per l'inserimento del punto di partenza -->
                      <input type="text" id="starting_point" name="starting_point" placeholder="Starting point">
                  </div>
                  <div class="col-3">
                      <button type="button" id="btn_start_point" name="btn_start_point" onclick="set_starting_coord()">Select </button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <label>End Point</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col-9">
                      <!-- campo per l'inserimento del punto di arrivo -->
                      <input type="text" id="ending_point" name="ending_point" placeholder="Ending point">
                  </div>
                  <div class="col-3">
                      <button type="button" id="btn_end_point" name="btn_end_point" onclick="set_ending_coord()">Select</button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <label>Date</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <!-- campo per l'inserimento della data -->
                      <input type="date" id="date" name="date" placeholder="Date">
                  </div>
                </div>

                <div class="row">
                  <div class="col-12">
                      <label>Arrival time</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <!-- campo per l'inserimento dell'ora di arrivo -->
                      <input type="time" id="arrival_time" name="arrival_time" placeholder="Ending time">
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <label>Travel time</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                      <!-- campo per l'inserimento del tempo di percorrenza massimo -->
                      <input type="time" id="travel_time" name="travel_time">
                  </div>
                </div>
                <div class="row">
                  <div class="col-9">
                  </div>
                  <div class="col-3">
                      <!-- pulsante di submit del form -->
                      <input type="submit" value="Request">
                  </div>
                </div>


            </form>
        </div>
        <div class="col-sm-8 pt-3">
            <div id="map"></div></div>
        </div>
    </div>
    <script>

        var map = L.map('map').setView([41.85578716505089, 12.62212090183184], 17);


        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        
        var busStopIcon = L.Icon.extend({
            options: {
                iconSize:     [60, 60],
                iconAnchor:   [30, 60]
            }
        });

        var busStopIconRed = new busStopIcon({iconUrl: '/static/resources/bus-stop-red.png' });
        var busStopIconGreen = new busStopIcon({iconUrl: '/static/resources/bus-stop-green.png' });
        var busStopIconBlue = new busStopIcon({iconUrl: '/static/resources/bus-stop-blue.png' });

        var bus_stops = {{ bus_stops | tojson }};

        var markersLayer = L.featureGroup().addTo(map);

        bus_stops.forEach(function(bus_stop) {
            var marker = L.marker([bus_stop["lat"], bus_stop["lang"]], {
                icon: busStopIconBlue,
                title: "(" + bus_stop["lat"] + "," + bus_stop["lang"] + ")"
            }).addTo(map);
            marker.bindTooltip(bus_stop["name"], {
                offset: L.point(0, -50)
            });
            //marker.on('click', onMarkerClick);
            marker.addTo(markersLayer)
        });

        markersLayer.on("click", markerOnClick);

        var startingPoint;
        var endingPoint;
        var point = null;

        function markerOnClick(e){
            if (point != null){
                if(point == "start"){
                    if (startingPoint != null)
                        startingPoint.setIcon(busStopIconBlue);
                    var clickedMarker = e.layer;
                    clickedMarker.setIcon(busStopIconGreen);
                    startingPoint = clickedMarker
                    bus_stop_name = clickedMarker.getTooltip().getContent()
                    document.getElementById("starting_point").value = bus_stop_name;
                }
                else if (point == "end"){
                    if (endingPoint != null)
                        endingPoint.setIcon(busStopIconBlue);
                    var clickedMarker = e.layer;
                    endingPoint = clickedMarker
                    clickedMarker.setIcon(busStopIconRed);
                    bus_stop_name = clickedMarker.getTooltip().getContent()
                    document.getElementById("ending_point").value = bus_stop_name;
                }
            }
        }


        function set_starting_coord(){
            point = "start";
        }

        function set_ending_coord(){
            point = "end";
        }
    if(document.getElementById("response").value == "True")
        alert("Your request has been successfully sent!")
    echo(sessionStorage.getItem("response"))
    </script>
    {{ response }}

{% endblock %}
